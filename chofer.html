<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chofer - Otimac ðŸš–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <style>
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #b39ddb; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.6s ease; }
        .logo-animado { font-size: 80px; animation: latido 1.5s infinite; }
        @keyframes latido { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #1a1a1a; color: white; margin: 0; padding: 0; overflow: hidden; }
        #btn-menu { position: fixed; top: 15px; left: 15px; z-index: 5000; background: rgba(179, 157, 219, 0.4); color: white; border: 1px solid white; width: 45px; height: 45px; border-radius: 50%; font-size: 24px; cursor: pointer; backdrop-filter: blur(5px); }
        #sidebar { position: fixed; top: 0; left: -320px; width: 260px; height: 100%; background: rgba(17, 17, 17, 0.95); z-index: 4500; transition: 0.4s; padding: 70px 15px 20px 15px; text-align: left; }
        #sidebar.active { left: 0; box-shadow: 10px 0 30px black; border-right: 2px solid #b39ddb; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 4000; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        #interfaz { position: fixed; bottom: 0; left: 0; right: 0; z-index: 2000; padding: 10px; }
        .panel-pedidos { background: rgba(0, 0, 0, 0.85); padding: 20px; border-radius: 25px 25px 15px 15px; border-top: 3px solid #b39ddb; backdrop-filter: blur(10px); }
        .pedido-card { padding: 15px; background: rgba(255,255,255,0.1); margin: 10px 0; border-radius: 12px; border-left: 6px solid #b39ddb; }
        .btn-aceptar { background:#b39ddb; border:none; padding:14px; border-radius:10px; font-weight:bold; width:100%; cursor: pointer; color: black; font-size: 16px; }
        .sidebar-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #b39ddb; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00ff00; }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body onload="iniciarAppCentral()">
    <div id="splash-screen">
        <div class="logo-animado">ðŸš–</div>
        <div style="font-size: 24px; font-weight: bold; margin-top: 10px; color: #1a1a1a;">OTIMAC CENTRAL</div>
    </div>
    <button id="btn-menu" onclick="toggleSidebar()">â˜°</button>
    <div id="overlay" onclick="toggleSidebar()"></div>
    <div id="sidebar">
        <div class="sidebar-item">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span id="txtModo" style="color:#ff4444; font-weight:bold;">DESCONECTADO</span>
                <label class="switch"><input type="checkbox" id="checkTrabajo" onchange="toggleTrabajo()"><span class="slider"></span></label>
            </div>
        </div>
        <div class="sidebar-item" onclick="editarDatos()">
            <div style="font-size: 11px; color:#b39ddb; margin-bottom: 5px;">TOQUE PARA EDITAR âœŽ</div>
            <div style="font-size: 16px; font-weight: bold;">ðŸ‘¤ <span id="displayNombre">...</span></div>
            <div style="font-size: 16px; font-weight: bold;">ðŸš• Eco: <span id="displayEco">...</span></div>
        </div>
        <div id="status-gps" style="color: #ff4444; font-size: 12px; padding-left: 5px;">ðŸ”´ GPS APAGADO</div>
    </div>
    <div id="map"></div>
    <div id="interfaz"><div class="panel-pedidos"><h3>Viajes Disponibles</h3><div id="lista-pedidos" style="color: #aaa;">Cargando sistema...</div></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        var firebaseConfig = { apiKey: "AIzaSyATLT5_woN8KO8-_E4_Nl7bEMlJGFI4uUQ", authDomain: "taxiotimac.firebaseapp.com", databaseURL: "https://taxiotimac-default-rtdb.firebaseio.com", projectId: "taxiotimac", storageBucket: "taxiotimac.firebasestorage.app", messagingSenderId: "533983007458", appId: "1:533983007458:web:254cef6b46c01a1718c4bb" };
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();
        var markerChofer, markerCliente, controlRuta, idViajeActivo, watchID;

        const svgTaxi = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzODQgNTEyIj48cGF0aCBmaWxsPSIjRkZEMzAwIiBkPSJNMzY4LjUgMzIwaC0zNTNDNy44IDMyMCAwIDMxMi4yIDAgMzAyLjhWMjA5LjJjMC05LjQgNy44LTE3IDMTcuNS0xN2gzNTNjOS43IDAgMTcuNSA3LjYgMTcuNSAxN3Y5My42YzAgOS40LTcuOCAxNy0xNy41IDE3eiIvPjxwYXRoIGZpbGw9IiNGRkQzMDAiIGQ9Ik0xOTIgOEM4NS45IDAgMCA4NS45IDAgMTkyYzAgNzUuMiA0NC4xIDEzOS4yIDEwNy44IDE3NkwxOTIgNTEybDg0LjItMTQ0QzMzOS45IDMzMS4yIDM4NCAyNjcuMiAzODQgMTkyIDM4NCA4NS45IDI5OC4xIDAgMTkyIDB6bTgzLjQgMjk2SDEwOC42di00MGgxNjd2NDB6bTAtNjRoLTE2N3YtNDBoMTY3djQweiIvPjwvc3ZnPg==';
        const svgUser = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzODQgNTEyIj48cGF0aCBmaWxsPSIjQjM5RERCIiBkPSJNMTkyIDBDODUuOSAwIDAgODUuOSAwIDE5MmMwIDc1LjIgNDQuMSAxMzkuMiAxMDcuOCAxNzZMMTkyIDUxMmw4NC4yLTE0NEMzMzkuOSAzMzEuMiAzODQgMjY3LjIgMzg0IDE5MiAzODQgODUuOSAyOTguMSAwIDE5MiAwem0wIDk2YzMzLjEgMCA2MCAyNi45IDYwIDYwcy0yNi45IDYwLTYwIDYwLTYwLTI2LjktNjAtNjAgMjYuOS02MCA2MC02MHptMTA0IDE5MmgtMjA4di04YzAtMzUuMyAyOC43LTY0IDY0LTY0aDgwYzM1LjMgMCA2NCAyOC43IDY0IDY0djh6Ii8+PC9zdmc+';

        var iconoTaxi = L.icon({ iconUrl: svgTaxi, iconSize: [45, 45], iconAnchor: [22, 45] });
        var iconoPasajero = L.icon({ iconUrl: svgUser, iconSize: [45, 45], iconAnchor: [22, 45] });

        function toggleSidebar() {
            var side = document.getElementById('sidebar');
            var over = document.getElementById('overlay');
            side.classList.toggle('active');
            over.style.display = side.classList.contains('active') ? 'block' : 'none';
        }

        function editarDatos() {
            let n = prompt("Nuevo nombre:", localStorage.getItem("choferNombre"));
            let e = prompt("Nuevo econÃ³mico:", localStorage.getItem("choferEco"));
            if(n && e) {
                localStorage.setItem("choferNombre", n);
                localStorage.setItem("choferEco", e);
                document.getElementById('displayNombre').innerText = n;
                document.getElementById('displayEco').innerText = e;
            }
        }

        function iniciarAppCentral() {
            let n = localStorage.getItem("choferNombre"), e = localStorage.getItem("choferEco");
            if(!n) { n = prompt("Nombre:"); e = prompt("EconÃ³mico:"); localStorage.setItem("choferNombre", n); localStorage.setItem("choferEco", e); }
            document.getElementById('displayNombre').innerText = n;
            document.getElementById('displayEco').innerText = e;

            // --- AUTO-CONECTAR SI ESTABA TRABAJANDO ---
            if(localStorage.getItem("trabajando") === "true") {
                document.getElementById('checkTrabajo').checked = true;
                toggleTrabajo();
            } else {
                document.getElementById('lista-pedidos').innerText = "Enciende el modo trabajo.";
            }

            setTimeout(() => { document.getElementById('splash-screen').style.opacity = '0'; setTimeout(() => document.getElementById('splash-screen').style.visibility = 'hidden', 600); }, 2000);
        }

        var map = L.map('map', { zoomControl: false }).setView([23.6, -102], 5);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}').addTo(map);

        function toggleTrabajo() {
            let activo = document.getElementById('checkTrabajo').checked;
            localStorage.setItem("trabajando", activo);
            if(activo) {
                document.getElementById('txtModo').innerText = "TRABAJANDO";
                document.getElementById('txtModo').style.color = "#00ff00";
                iniciarGPS(); escucharPedidos();
            } else {
                if(watchID) navigator.geolocation.clearWatch(watchID);
                location.reload();
            }
        }

        function iniciarGPS() {
            watchID = navigator.geolocation.watchPosition((pos) => {
                let lat = pos.coords.latitude, lon = pos.coords.longitude;
                document.getElementById('status-gps').innerText = "âœ… GPS ACTIVO";
                document.getElementById('status-gps').style.color = "#00ff00";
                if(markerChofer) markerChofer.setLatLng([lat, lon]);
                else { markerChofer = L.marker([lat, lon], {icon: iconoTaxi}).addTo(map); map.setView([lat, lon], 17); }
                if(idViajeActivo) database.ref('viajes/' + idViajeActivo + '/chofer').update({ lat, lon });
            }, (err) => {
                console.error(err);
                document.getElementById('status-gps').innerText = "âš ï¸ ERROR GPS";
            }, {enableHighAccuracy: true, maximumAge: 0});
        }

        function escucharPedidos() {
            database.ref('viajes').on('value', (snap) => {
                let pedidos = snap.val(), cont = document.getElementById('lista-pedidos');
                if(!idViajeActivo) {
                    cont.innerHTML = "";
                    let hayViajes = false;
                    for(let id in pedidos) {
                        if(pedidos[id].estado === 'esperando') {
                            hayViajes = true;
                            cont.innerHTML += `<div class="pedido-card"><b>PASAJERO:</b> ${pedidos[id].nombre_cliente}<br><button class="btn-aceptar" onclick="aceptarViaje('${id}')">ACEPTAR VIAJE</button></div>`;
                        }
                    }
                    if(!hayViajes) cont.innerText = "Esperando solicitudes...";
                }
            });
        }

        function aceptarViaje(id) {
            idViajeActivo = id;
            database.ref('viajes/' + id).update({ estado: 'en_curso', chofer: { nombre: localStorage.getItem("choferNombre"), economico: localStorage.getItem("choferEco") } });
            database.ref('viajes/' + id + '/cliente').once('value', (s) => {
                let p = s.val();
                if(markerCliente) map.removeLayer(markerCliente);
                markerCliente = L.marker([p.lat, p.lon], {icon: iconoPasajero}).addTo(map);
                document.getElementById('interfaz').innerHTML = `<div class="panel-pedidos"><h3>VIAJE EN CURSO</h3><button class="btn-aceptar" style="background:#ff4444; color:white;" onclick="location.reload()">FINALIZAR</button></div>`;
            });
        }
    </script>
</body>
</html>
