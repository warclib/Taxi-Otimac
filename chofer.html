<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chofer - Otimac üöñ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: white; margin: 0; padding: 0; overflow: hidden; }
        
        /* PANTALLA CARGA */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #b39ddb; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; transition: 0.5s; }
        .logo-animado { font-size: 80px; }
        
        /* INTERFAZ */
        #btn-menu { position: fixed; top: 15px; left: 15px; z-index: 5000; background: rgba(179,157,219,0.3); color: white; border: 1px solid #fff; width: 45px; height: 45px; border-radius: 50%; font-size: 24px; }
        #sidebar { position: fixed; top: 0; left: -300px; width: 260px; height: 100%; background: rgba(0,0,0,0.9); z-index: 4500; transition: 0.3s; padding: 20px; text-align: left; box-sizing: border-box; }
        #sidebar.active { left: 0; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 4000; }
        
        #map { height: 100vh; width: 100%; z-index: 1; }
        #interfaz { position: fixed; bottom: 0; left: 0; right: 0; z-index: 2000; padding: 10px; }
        
        .panel-pedidos { background: #222; padding: 15px; border-radius: 20px 20px 0 0; border-top: 3px solid #b39ddb; max-height: 40vh; overflow-y: auto; }
        .pedido-card { background: #333; padding: 10px; margin-bottom: 10px; border-radius: 10px; text-align: left; position: relative; }
        
        .btn-aceptar { background: #b39ddb; border: none; padding: 10px; width: 100%; font-weight: bold; margin-top: 5px; cursor: pointer; }
        .btn-cancelar { background: #ff4444; color: white; border: none; padding: 15px; width: 100%; font-weight: bold; border-radius: 10px; }
        
        .btn-navegar-maps { background: #4285F4; color: white; border: none; padding: 10px; width: 48%; border-radius: 5px; font-weight: bold; }
        .btn-navegar-waze { background: #33ccff; color: white; border: none; padding: 10px; width: 48%; border-radius: 5px; font-weight: bold; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; float: right; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00ff00; }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="logo-animado">üöñ</div>
        <h2 style="color: black;">OTIMAC</h2>
        <small style="color: black;">Cargando sistema...</small>
    </div>

    <button id="btn-menu" onclick="toggleSidebar()">‚ò∞</button>
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div id="sidebar">
        <h2 style="color: #b39ddb; text-align: center;">MEN√ö</h2>
        
        <div style="background: #333; padding: 10px; border-radius: 10px; margin-bottom: 20px;">
            <span style="color: #aaa; font-size: 12px;">MODO TRABAJO</span>
            <div style="margin-top: 5px;">
                <span id="txtModo" style="color: #ff4444; font-weight: bold;">OFF</span>
                <label class="switch">
                    <input type="checkbox" id="checkTrabajo" onchange="toggleTrabajo()">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="margin-top: 10px; font-size: 12px;">
                GPS: <span id="status-gps" style="color: #ff4444;">INACTIVO</span>
            </div>
        </div>

        <div style="background: #333; padding: 10px; border-radius: 10px;">
            <small style="color: #aaa;">CHOFER</small>
            <div id="displayNombre" style="font-weight: bold; font-size: 18px;">...</div>
            <small style="color: #aaa;">ECON√ìMICO</small>
            <div id="displayEco" style="color: #b39ddb; font-weight: bold; font-size: 20px;">...</div>
            <button onclick="cambiarDatos()" style="background: transparent; border: 1px solid #777; color: #ccc; margin-top: 10px; width: 100%; padding: 5px;">Editar Datos</button>
        </div>
    </div>

    <div id="map"></div>

    <div id="interfaz">
        <div class="panel-pedidos">
            <h4 style="margin: 0 0 10px 0; color: #b39ddb; text-align: center;">VIAJES DISPONIBLES</h4>
            <div id="lista-pedidos" style="font-size: 14px; color: #aaa;">Enciende el modo trabajo.</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- 1. SEGURIDAD: QUITAR PANTALLA DE CARGA PASE LO QUE PASE ---
        setTimeout(function() {
            document.getElementById('splash-screen').style.display = 'none';
        }, 3000);

        // --- 2. CONFIGURACI√ìN FIREBASE ---
        var firebaseConfig = { apiKey: "AIzaSyATLT5_woN8KO8-_E4_Nl7bEMlJGFI4uUQ", authDomain: "taxiotimac.firebaseapp.com", databaseURL: "https://taxiotimac-default-rtdb.firebaseio.com", projectId: "taxiotimac", storageBucket: "taxiotimac.firebasestorage.app", messagingSenderId: "533983007458", appId: "1:533983007458:web:254cef6b46c01a1718c4bb" };
        
        try {
            firebase.initializeApp(firebaseConfig);
            var database = firebase.database();
        } catch(e) {
            alert("Error conectando: Revisa tu internet");
        }

        // --- 3. VARIABLES Y MAPA ---
        var map = L.map('map', {zoomControl: false}).setView([23.6345, -102.5528], 5);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}').addTo(map);

        var iconoTaxi = L.icon({ iconUrl: 'https://img.icons8.com/fluency/96/taxi-location.png', iconSize: [50, 50], iconAnchor: [25, 50] });
        var iconoPasajero = L.icon({ iconUrl: 'https://img.icons8.com/fluency/96/marker.png', iconSize: [45, 45], iconAnchor: [22, 45] });

        var markerChofer, markerCliente, controlRuta, idViajeActivo;
        var viajesRechazados = [];
        var ultimoGPS = 0;

        // INICIAR DATOS
        var n = localStorage.getItem("choferNombre");
        var e = localStorage.getItem("choferEco");
        if(!n) { cambiarDatos(); } else { actualizarDisplay(); }

        function cambiarDatos() {
            var nn = prompt("Nombre:");
            var ee = prompt("Econ√≥mico:");
            if(nn && ee) {
                localStorage.setItem("choferNombre", nn);
                localStorage.setItem("choferEco", ee);
                location.reload();
            }
        }

        function actualizarDisplay() {
            document.getElementById('displayNombre').innerText = localStorage.getItem("choferNombre");
            document.getElementById('displayEco').innerText = localStorage.getItem("choferEco");
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            var over = document.getElementById('overlay');
            over.style.display = over.style.display === 'block' ? 'none' : 'block';
        }

        function toggleTrabajo() {
            var check = document.getElementById('checkTrabajo');
            if(check.checked) {
                // VERIFICAR PERMISO EN FIREBASE
                var eco = localStorage.getItem("choferEco");
                database.ref('autorizados/' + eco).once('value', function(snapshot) {
                    if(snapshot.exists()) {
                        document.getElementById('txtModo').innerText = "ON";
                        document.getElementById('txtModo').style.color = "#00ff00";
                        iniciarGPS();
                        escucharPedidos();
                    } else {
                        alert("Econ√≥mico NO AUTORIZADO");
                        check.checked = false;
                    }
                });
            } else {
                location.reload();
            }
        }

        function iniciarGPS() {
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(function(pos) {
                    var lat = pos.coords.latitude;
                    var lon = pos.coords.longitude;
                    var miPos = [lat, lon];

                    document.getElementById('status-gps').innerText = "ACTIVO";
                    document.getElementById('status-gps').style.color = "#00ff00";

                    if(markerChofer) markerChofer.setLatLng(miPos);
                    else { markerChofer = L.marker(miPos, {icon: iconoTaxi}).addTo(map); map.setView(miPos, 16); }

                    // Actualizar en FB cada 5 segs
                    var ahora = Date.now();
                    if(ahora - ultimoGPS > 5000 && idViajeActivo) {
                        ultimoGPS = ahora;
                        database.ref('viajes/' + idViajeActivo + '/chofer').update({ lat: lat, lon: lon });
                    }

                }, null, {enableHighAccuracy: true});
            }
        }

        function escucharPedidos() {
            database.ref('viajes').on('value', function(snapshot) {
                var pedidos = snapshot.val();
                if(!idViajeActivo) renderizarLista(pedidos);
            });
        }

        function renderizarLista(pedidos) {
            var div = document.getElementById('lista-pedidos');
            div.innerHTML = "";
            
            if(!pedidos) { div.innerHTML = "Esperando..."; return; }

            for(var id in pedidos) {
                var p = pedidos[id];
                if(p.estado === 'esperando' && !viajesRechazados.includes(id)) {
                    // C√°lculo simple de distancia (lineal)
                    var km = "...";
                    if(markerChofer) {
                        km = (map.distance(markerChofer.getLatLng(), [p.cliente.lat, p.cliente.lon]) / 1000).toFixed(1);
                    }

                    div.innerHTML += `
                    <div class="pedido-card">
                        <div style="float:right; color: #b39ddb; font-weight:bold;">${km} km</div>
                        <div style="font-weight:bold; font-size:18px;">${p.nombre_cliente}</div>
                        <div>‚≠ê ${p.cliente_estrellas}</div>
                        <button class="btn-aceptar" onclick="aceptar('${id}')">ACEPTAR</button>
                        <button class="btn-rechazar" onclick="this.parentElement.style.display='none'; viajesRechazados.push('${id}')" style="background:none; border:none; color:#777; width:100%; margin-top:5px;">Ocultar</button>
                    </div>`;
                }
            }
            if(div.innerHTML === "") div.innerHTML = "Esperando solicitudes...";
        }

        function aceptar(id) {
            idViajeActivo = id;
            var nombre = localStorage.getItem("choferNombre");
            var eco = localStorage.getItem("choferEco");
            var lat = markerChofer.getLatLng().lat;
            var lng = markerChofer.getLatLng().lng;

            database.ref('viajes/' + id).update({
                estado: 'en_curso',
                chofer: { nombre: nombre, economico: eco, lat: lat, lon: lng }
            });

            // MOSTRAR INTERFAZ DE VIAJE
            database.ref('viajes/' + id + '/cliente').once('value', function(snap) {
                var c = snap.val();
                mostrarViajeActivo(c.lat, c.lon, id);
            });
        }

        function mostrarViajeActivo(lat, lon, id) {
            if(markerCliente) map.removeLayer(markerCliente);
            markerCliente = L.marker([lat, lon], {icon: iconoPasajero}).addTo(map);

            // Trazar ruta
            if(controlRuta) map.removeControl(controlRuta);
            controlRuta = L.Routing.control({
                waypoints: [markerChofer.getLatLng(), L.latLng(lat, lon)],
                show: false, createMarker: function() { return null; },
                lineOptions: { styles: [{color: '#b39ddb', weight: 6}] }
            }).addTo(map);

            // CORRECCI√ìN DEL LINK DE MAPAS (Concatenaci√≥n simple para evitar errores)
            var linkMaps = 'https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lon + '&travelmode=driving';
            var linkWaze = 'https://www.waze.com/ul?ll=' + lat + ',' + lon + '&navigate=yes';

            document.getElementById('interfaz').innerHTML = `
                <div class="panel-pedidos">
                    <h3 style="color:#b39ddb; text-align:center; margin-top:0;">EN CURSO</h3>
                    <div style="display:flex; justify-content:space-between;">
                        <button class="btn-navegar-waze" onclick="window.open('${linkWaze}')">WAZE</button>
                        <button class="btn-navegar-maps" onclick="window.open('${linkMaps}')">MAPS</button>
                    </div>
                    <button class="btn-cancelar" onclick="finalizar('${id}')">FINALIZAR VIAJE</button>
                </div>`;
        }

        function finalizar(id) {
            if(confirm("¬øFinalizar viaje?")) {
                database.ref('viajes/' + id).remove();
                location.reload();
            }
        }
    </script>
</body>
</html>
