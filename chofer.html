// --- COPIA ESTA VERSI√ìN MEJORADA DE LA FUNCI√ìN DE VOZ ---
function avisarConVoz(mensaje) {
    if ('speechSynthesis' in window) {
        // 1. Limpiamos cualquier voz pendiente para que no se "trabe" en Android
        window.speechSynthesis.cancel();

        var nombreChofer = localStorage.getItem("choferNombre") || "Chofer";
        var textoFinal = mensaje;
        
        // Si es un nuevo viaje, mencionamos al chofer
        if (mensaje.includes("nuevo viaje")) {
            textoFinal = nombreChofer + ", " + mensaje;
        }

        var msg = new SpeechSynthesisUtterance();
        msg.text = textoFinal; 
        msg.lang = 'es-MX';
        msg.rate = 1.0;
        msg.pitch = 1.0;
        msg.volume = 1.0;

        // 2. Truco para Android: Intentar hablar inmediatamente
        window.speechSynthesis.speak(msg);
        
        // 3. Verificaci√≥n de error (si Android bloquea, lo intentamos una vez m√°s tras 500ms)
        msg.onerror = function(e) {
            console.error("Error de s√≠ntesis:", e);
            setTimeout(() => { window.speechSynthesis.speak(msg); }, 500);
        };
    }
}

// --- ACTUALIZACI√ìN EN LA FUNCI√ìN DE RENDERIZAR PARA EL BANEO ---
function renderizarListaPedidos(pedidos) {
    var contenedor = document.getElementById('lista-pedidos');
    if (!idViajeActivo && document.getElementById('checkTrabajo').checked) {
        contenedor.innerHTML = "";
        let conteoActual = 0;
        for (var id in pedidos) {
            if (pedidos[id].estado === 'esperando' && !viajesRechazados.includes(id)) {
                conteoActual++;
                var cli = pedidos[id].cliente;
                var km = markerChofer ? (L.latLng(markerChofer.getLatLng()).distanceTo(L.latLng(cli.lat, cli.lon)) / 1000).toFixed(1) : "...";
                
                var estrellas = pedidos[id].cliente_estrellas || "5.0";
                var totalV = pedidos[id].cliente_historial || "0";
                
                // IMPORTANTE: El 'id' aqu√≠ es el V-XXXXXX que usaremos para aceptar
                contenedor.innerHTML += `
                <div class="pedido-card">
                    <span class="distancia-tag">üìç ${km} km</span>
                    <b>${pedidos[id].nombre_cliente || "Pasajero"}</b> 
                    <span class="badge-confianza">Verificado</span>
                    <div style="margin: 5px 0;">
                        <span class="rating-estrella">‚≠ê ${estrellas}</span>
                        <small style="color:#aaa; margin-left:10px;">Historial: ${totalV} viajes</small>
                    </div>
                    <button class="btn-aceptar" onclick="aceptarViaje('${id}')">ACEPTAR VIAJE</button>
                    <button class="btn-rechazar" onclick="rechazarViajeLocal('${id}')">OCULTAR</button>
                </div>`;
            }
        }
        
        // L√≥gica de disparo de sonido y voz
        if (conteoActual > ultimoConteoPedidos) {
            // Reproducir sonido de campana
            audioNotificacion.play().catch(e=>{ console.log("Audio bloqueado por navegador"); });
            // Disparar voz corregida
            avisarConVoz("tienes un nuevo viaje disponible.");
        }
        ultimoConteoPedidos = conteoActual;
        if (conteoActual === 0) contenedor.innerHTML = "Esperando solicitudes...";
    }
}

// --- FUNCI√ìN TERMINAR VIAJE (CON EL CALCULO MATEM√ÅTICO YA LISTO) ---
function terminarViaje(id) {
    let calif = prompt("Califica al cliente (Escribe un n√∫mero del 1 al 5):", "5");
    if (calif === null) return; 

    let nuevaCalificacion = parseFloat(calif);
    if (isNaN(nuevaCalificacion) || nuevaCalificacion < 1 || nuevaCalificacion > 5) {
        alert("‚ö†Ô∏è ERROR: Debes ingresar un n√∫mero v√°lido entre 1 y 5.");
        return;
    }

    database.ref('viajes/' + id).once('value', (snapshot) => {
        var datos = snapshot.val();
        
        // Usamos cliente_uid para actualizar el perfil global y para que el BANEO funcione
        if (datos && datos.cliente_uid) {
            var uidPasajero = datos.cliente_uid;
            var perfilRef = database.ref('usuarios/' + uidPasajero + '/perfil');
            
            perfilRef.once('value').then((snap) => {
                let perfil = snap.val() || { estrellas: 5.0, total_viajes: 0 };
                let viajesAnteriores = parseInt(perfil.total_viajes) || 0;
                let estrellasAnteriores = parseFloat(perfil.estrellas) || 5.0;

                let viajesTotales = viajesAnteriores + 1;
                let nuevoPromedio = ((estrellasAnteriores * viajesAnteriores) + nuevaCalificacion) / viajesTotales;
                nuevoPromedio = Math.round(nuevoPromedio * 10) / 10;

                return perfilRef.update({
                    total_viajes: viajesTotales,
                    estrellas: nuevoPromedio
                });
            }).then(() => {
                cerrarServicio(id);
            }).catch(err => {
                cerrarServicio(id);
            });
        } else {
            cerrarServicio(id);
        }
    });
}
