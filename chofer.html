<script>
    // ... (Configuraci√≥n de Firebase y variables globales se mantienen igual)

    function escucharPedidos() {
        database.ref('viajes').on('value', (snapshot) => {
            var pedidos = snapshot.val();
            var ahora = Date.now();
            var limiteTiempo = 5 * 60 * 1000; // 5 minutos en milisegundos

            window.ultimoSnapshotPedidos = pedidos;
            
            if (!pedidos) {
                viajesRechazados = [];
            } else {
                let hayEsperando = false;
                for (var id in pedidos) {
                    var v = pedidos[id];

                    // --- L√ìGICA DE AUTOLIMPIEZA (5 MINUTOS) ---
                    if (v.estado === 'esperando' && v.timestamp) {
                        var tiempoTranscurrido = ahora - v.timestamp;
                        if (tiempoTranscurrido > limiteTiempo) {
                            database.ref('viajes/' + id).remove(); // Borra viaje fantasma
                            continue; 
                        }
                    }
                    // ------------------------------------------

                    if (v.estado === 'esperando') {
                        hayEsperando = true;
                    }
                }
                if (!hayEsperando) { viajesRechazados = []; }
            }
            renderizarListaPedidos(pedidos);
        });
    }

    // Nueva funci√≥n para el Chat (Lado Chofer)
    function enviarMensajeChat(idV) {
        var msg = document.getElementById('inputChat').value;
        if (msg.trim() !== "") {
            database.ref('chats/' + idV + '/mensajes').push({
                user: "Chofer",
                msg: msg,
                time: firebase.database.ServerValue.TIMESTAMP
            });
            document.getElementById('inputChat').value = "";
        }
    }

    function escucharChat(idV) {
        var chatBox = document.getElementById('chat-box');
        if(!chatBox) return;

        database.ref('chats/' + idV + '/mensajes').on('child_added', (snap) => {
            var m = snap.val();
            var align = (m.user === "Chofer") ? "align-self: flex-end; background: #b39ddb; color: black;" : "align-self: flex-start; background: #444; color: white;";
            
            chatBox.innerHTML += `<div style="${align} padding: 8px; border-radius: 10px; margin-bottom: 5px; max-width: 80%; word-wrap: break-word; font-size: 13px;">
                <b style="font-size: 10px;">${m.user}</b><br>${m.msg}
            </div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            if (m.user === "Cliente") {
                avisarConVoz("Mensaje del cliente: " + m.msg);
            }
        });
    }

    // Modificamos dibujarInterfazYRuta para incluir el chat visualmente
    function dibujarInterfazYRuta(lat, lon, id) {
        document.getElementById('interfaz').innerHTML = `
            <div class="panel-pedidos">
                <h3 style="margin:0 0 10px 0; font-size:14px; color:#b39ddb;">VIAJE ACTIVO</h3>
                
                <div id="chat-box" style="height: 100px; overflow-y: auto; display: flex; flex-direction: column; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px; margin-bottom: 8px; border: 1px solid rgba(179, 157, 219, 0.3);"></div>
                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <input type="text" id="inputChat" placeholder="Mensaje al cliente..." style="flex: 1; padding: 8px; border-radius: 5px; border: none; background: #333; color: white;">
                    <button onclick="enviarMensajeChat('${id}')" style="background: #b39ddb; border:none; padding: 8px 15px; border-radius: 5px; font-weight: bold;">‚úàÔ∏è</button>
                </div>

                <div class="contenedor-navegacion">
                    <button class="btn-navegar-waze" onclick="window.open('https://www.waze.com/ul?ll=${lat},${lon}&navigate=yes')">üöô WAZE</button>
                    <button class="btn-navegar-maps" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving')">üìç MAPS</button>
                </div>
                <button class="btn-cancelar" onclick="terminarViaje('${id}')">FINALIZAR SERVICIO</button>
            </div>`;
        
        escucharChat(id); // Activamos el escucha del chat al dibujar la interfaz

        if(markerCliente) map.removeLayer(markerCliente);
        markerCliente = L.marker([lat, lon], {icon: iconoPasajero}).addTo(map);
        
        if(markerChofer) {
            if(controlRuta) map.removeControl(controlRuta);
            controlRuta = L.Routing.control({
                waypoints: [markerChofer.getLatLng(), L.latLng(lat, lon)],
                show: false, createMarker: () => null,
                lineOptions: { styles: [{ color: '#b39ddb', weight: 6 }] }
            }).addTo(map);
        }
    }

    // Al finalizar el viaje, tambi√©n borramos el chat
    function terminarViaje(id) {
        let califInput = prompt("Califica al cliente (1-5):", "5");
        if (califInput === null) return;
        let estrellasDadas = parseInt(califInput);

        if (isNaN(estrellasDadas) || estrellasDadas < 1 || estrellasDadas > 5) {
            alert("‚ùå ERROR: Solo n√∫meros del 1 al 5.");
            return terminarViaje(id);
        }

        database.ref('viajes/' + id).once('value', (snapshot) => {
            var datos = snapshot.val();
            if (datos && datos.cliente_uid) {
                let clienteRef = database.ref('usuarios/' + datos.cliente_uid + '/perfil');
                clienteRef.transaction((perfil) => {
                    if (perfil) {
                        perfil.total_viajes = (perfil.total_viajes || 0) + 1;
                        perfil.puntos_acumulados = (perfil.puntos_acumulados || 0) + estrellasDadas;
                        perfil.estrellas = parseFloat((perfil.puntos_acumulados / perfil.total_viajes).toFixed(1));
                    }
                    return perfil;
                });
            }
        });

        localStorage.removeItem("idViajeChoferActivo");
        database.ref('chats/' + id).remove(); // Borramos el chat al finalizar
        database.ref('viajes/' + id).remove().then(() => { 
            alert("Servicio finalizado.");
            location.reload(); 
        });
    }
</script>
