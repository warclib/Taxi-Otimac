<script>
    // ... (Configuración Firebase igual) ...

    function aceptarViaje(id) {
        // Obtenemos los datos guardados en el celular
        var nombreChofer = localStorage.getItem("choferNombre") || "Chofer Otimac";
        var ecoChofer = localStorage.getItem("choferEco") || "S/N";

        localStorage.setItem("idViajeChoferActivo", id);
        
        // ACTUALIZACIÓN CRÍTICA: Enviar datos completos al cliente
        database.ref('viajes/' + id).update({ 
            estado: 'en_curso',
            chofer: {
                nombre: nombreChofer,
                economico: ecoChofer,
                lat: markerChofer.getLatLng().lat,
                lon: markerChofer.getLatLng().lng
            }
        });
        
        reconectarViajeChofer(id);
    }

    function reconectarViajeChofer(id) {
        idViajeActivo = id;
        document.getElementById('interfaz').innerHTML = `
            <div class="panel-pedidos">
                <h3 style="margin:0;">VIAJE ACTIVO #${id}</h3>
                <button class="btn-cancelar" onclick="terminarViaje('${id}')">FINALIZAR SERVICIO</button>
            </div>`;
        
        // Escuchar posición del cliente para dibujar la ruta
        database.ref('viajes/' + id + '/cliente').once('value', (snap) => {
            var posC = snap.val();
            if(!posC) return;
            if(markerCliente) map.removeLayer(markerCliente);
            markerCliente = L.marker([posC.lat, posC.lon], {icon: iconoPasajero}).addTo(map);

            if(controlRuta) map.removeControl(controlRuta);
            controlRuta = L.Routing.control({
                waypoints: [markerChofer.getLatLng(), L.latLng(posC.lat, posC.lon)],
                show: false, // OCULTA LA PESTAÑA BLANCA
                addWaypoints: false,
                createMarker: function() { return null; },
                lineOptions: { styles: [{ color: '#2478ff', weight: 6 }] }
            }).addTo(map);
            
            var group = new L.featureGroup([markerChofer, markerCliente]);
            map.fitBounds(group.getBounds().pad(0.3));
        });
    }
    // ... (Resto del código igual) ...
</script>
