<script>
    // ... (Configuración Firebase igual) ...

    function reconectarViaje(id) {
        document.getElementById('btnPedir').style.display = 'none';
        document.getElementById('btnCancelar').style.display = 'block';
        document.getElementById('status-viaje').innerHTML = "⏳ Esperando confirmación...";

        // ESCUCHAR DATOS DEL VIAJE COMPLETO
        database.ref('viajes/' + id).on('value', (snap) => {
            var viaje = snap.val();
            if(!viaje) {
                localStorage.removeItem("idViajeActivo");
                location.reload();
                return;
            }

            // Si el chofer ya aceptó y puso sus datos
            if (viaje.chofer && viaje.chofer.nombre) {
                document.getElementById('status-viaje').innerHTML = "✅ ¡Tu taxi va en camino!";
                document.getElementById('cardChofer').style.display = 'block';
                document.getElementById('infoChofer').innerHTML = `<b>Taxi:</b> ${viaje.chofer.economico} | <b>Chofer:</b> ${viaje.chofer.nombre}`;
                
                var posChofer = [viaje.chofer.lat, viaje.chofer.lon];
                if (markerChofer) markerChofer.setLatLng(posChofer);
                else markerChofer = L.marker(posChofer, {icon: iconoTaxi}).addTo(map);

                // Ajustar mapa para ver a ambos
                if(markerCliente) {
                    var group = new L.featureGroup([markerCliente, markerChofer]);
                    map.fitBounds(group.getBounds().pad(0.2));
                }
            }
        });

        // Dibujar mi posición inicial
        database.ref('viajes/' + id + '/cliente').once('value', (snap) => {
            var p = snap.val();
            if(p) {
                if (markerCliente) markerCliente.setLatLng([p.lat, p.lon]);
                else markerCliente = L.marker([p.lat, p.lon], {icon: iconoPasajero}).addTo(map);
            }
        });
    }
</script>
