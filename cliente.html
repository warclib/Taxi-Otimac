function reconectarViaje(id) {
    document.getElementById('btnPedir').style.display = 'none';
    document.getElementById('btnCancelar').style.display = 'block';

    database.ref('viajes/' + id).on('value', (snap) => {
        var viaje = snap.val();
        
        // --- ESTA ES LA MEJORA CLAVE ---
        if(!viaje) { 
            // Si el viaje ya no existe en Firebase (porque el chofer lo termin√≥ o cancel√≥)
            localStorage.removeItem("idViajeActivo"); // Borramos la memoria
            alert("El servicio ha finalizado."); // Avisamos al usuario
            location.reload(); // Refrescamos para que pueda pedir otro
            return; 
        }
        // -------------------------------

        if (viaje.estado === 'chofer_llego') {
            document.getElementById('alertaLlegada').style.display = 'block';
            document.getElementById('status-viaje').innerText = "üö© ¬°TU TAXI LLEG√ì!";
        }

        if (viaje.cliente) {
            var posC = [viaje.cliente.lat, viaje.cliente.lon];
            if (markerCliente) markerCliente.setLatLng(posC);
            else markerCliente = L.marker(posC, {icon: iconoPasajero}).addTo(map);
        }

        if (viaje.chofer && viaje.chofer.nombre) {
            document.getElementById('cardChofer').style.display = 'block';
            document.getElementById('status-viaje').innerText = "üöï Taxi en camino";
            
            var dist = L.latLng(markerCliente.getLatLng()).distanceTo(L.latLng(viaje.chofer.lat, viaje.chofer.lon));
            var minutos = Math.round(dist / 300);
            if (minutos < 1) minutos = 1;

            document.getElementById('infoChofer').innerHTML = `
                <b>Taxista:</b> ${viaje.chofer.nombre}<br>
                <b>Unidad:</b> ${viaje.chofer.economico}`;
            
            document.getElementById('tiempoEstimado').innerText = `‚è±Ô∏è Llega en aprox: ${minutos} min`;

            var posT = [viaje.chofer.lat, viaje.chofer.lon];
            if (markerChofer) markerChofer.setLatLng(posT);
            else markerChofer = L.marker(posT, {icon: iconoTaxi}).addTo(map);

            var group = new L.featureGroup([markerCliente, markerChofer]);
            map.fitBounds(group.getBounds().pad(0.3));
        }
    });
}
