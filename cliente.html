<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasajero - TaxiOtimac</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f4f4f4; margin: 0; padding: 15px; }
        #map { height: 400px; width: 100%; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-top: 15px; }
        .status-box { background: white; padding: 20px; border-radius: 12px; margin-bottom: 10px; border: 2px solid #ffc107; }
        #viaje-id { font-size: 32px; color: #333; font-weight: bold; display: block; margin: 10px 0; letter-spacing: 5px; }
        .tiempo-info { color: #2478ff; font-weight: bold; font-size: 18px; margin-top: 5px; }
        .btn-pedir { background: #000; color: #fff; border: none; padding: 18px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 10px; width: 100%; }
    </style>
</head>
<body>

    <div class="status-box">
        <div id="status">Presiona el bot√≥n para pedir tu taxi</div>
        <div id="info-viaje" style="display:none;">
            TU C√ìDIGO DE VIAJE:
            <span id="viaje-id"></span>
            <div id="estimacion" class="tiempo-info"></div>
        </div>
    </div>

    <button class="btn-pedir" id="btnPedir" onclick="pedirTaxi()">üöñ PEDIR TAXI AHORA</button>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Configuraci√≥n Firebase (La tuya se mantiene igual)
        var firebaseConfig = {
            apiKey: "AIzaSyATLT5_woN8KO8-_E4_Nl7bEMlJGFI4uUQ",
            authDomain: "taxiotimac.firebaseapp.com",
            databaseURL: "https://taxiotimac-default-rtdb.firebaseio.com",
            projectId: "taxiotimac",
            storageBucket: "taxiotimac.firebasestorage.app",
            messagingSenderId: "533983007458",
            appId: "1:533983007458:web:254cef6b46c01a1718c4bb"
        };
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();

        var map = L.map('map').setView([23.6345, -102.5528], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        var markerCliente, markerChofer, idDelViaje;
        var iconTaxi = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448636.png', iconSize: [45, 45] });

        function pedirTaxi() {
            idDelViaje = Math.floor(Math.random() * 90000) + 10000;
            document.getElementById('info-viaje').style.display = 'block';
            document.getElementById('viaje-id').innerText = idDelViaje;
            document.getElementById('btnPedir').style.display = 'none';

            navigator.geolocation.getCurrentPosition((pos) => {
                var lat = pos.coords.latitude;
                var lon = pos.coords.longitude;
                map.setView([lat, lon], 16);
                markerCliente = L.marker([lat, lon]).addTo(map);

                database.ref('viajes/' + idDelViaje).set({
                    cliente: { lat: lat, lon: lon },
                    estado: "esperando"
                });
                escucharEstadoViaje();
            }, (err) => alert("Activa el GPS"));
        }

        function escucharEstadoViaje() {
            database.ref('viajes/' + idDelViaje).on('value', (snapshot) => {
                var viaje = snapshot.val();
                if (!viaje) return;

                if (viaje.estado === "cancelado") {
                    alert("Viaje finalizado.");
                    location.reload();
                }

                if (viaje.chofer) {
                    var latLngChofer = L.latLng(viaje.chofer.lat, viaje.chofer.lon);
                    var latLngCliente = markerCliente.getLatLng();
                    var distanciaMetros = latLngChofer.distanceTo(latLngCliente);
                    var distKm = (distanciaMetros / 1000).toFixed(1);
                    
                    // C√°lculo de tiempo (promedio 40km/h en ciudad)
                    var tiempoMinutos = Math.round((distanciaMetros / 666)); 
                    var horas = Math.floor(tiempoMinutos / 60);
                    var mins = tiempoMinutos % 60;
                    var tiempoTexto = horas > 0 ? horas + " h " + mins + " min" : mins + " min";

                    document.getElementById('status').innerHTML = `<b>¬°Taxi en camino!</b>`;
                    document.getElementById('estimacion').innerHTML = `üìç Distancia: ${distKm} km<br>‚è±Ô∏è Llega en: ${tiempoTexto}`;
                    
                    if (markerChofer) markerChofer.setLatLng(latLngChofer);
                    else markerChofer = L.marker(latLngChofer, {icon: iconTaxi}).addTo(map);
                }
            });
        }
    </script>
</body>
</html>
