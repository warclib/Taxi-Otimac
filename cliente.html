<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliente - Otimac ðŸš–</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: white; margin: 0; padding: 10px; }
        
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #b39ddb; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; }
        
        #map { height: 400px; width: 100%; border-radius: 15px; border: 2px solid #b39ddb; margin-top: 10px; }
        
        .btn-pedido { background: #b39ddb; color: black; border: none; padding: 20px; font-weight: bold; border-radius: 10px; width: 100%; font-size: 18px; margin-top: 10px; cursor: pointer; }
        .btn-cancelar { background: #ff4444; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; }
        
        .card-chofer { background: #222; padding: 15px; border-radius: 12px; border: 2px solid #b39ddb; margin-bottom: 10px; display: none; text-align: left; }
        
        input { padding: 15px; width: 90%; margin-bottom: 10px; border-radius: 5px; border: none; }
        
        /* BARRA TIEMPO */
        #barra-wrapper { width: 100%; background: #333; height: 5px; margin-top: 10px; display: none; }
        #barra-fill { height: 100%; background: #ffca28; width: 100%; transition: width 1s linear; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div style="font-size: 80px;">ðŸš–</div>
        <h2 style="color:black;">OTIMAC</h2>
    </div>

    <div id="registro" style="display:none; padding-top: 50px;">
        <h3>Bienvenido</h3>
        <input type="text" id="inputNombre" placeholder="Tu nombre aquÃ­">
        <button class="btn-pedido" onclick="guardarNombre()">ENTRAR</button>
    </div>

    <div id="app" style="display:none;">
        <h3 id="saludo">Hola</h3>
        
        <div id="cardChofer" class="card-chofer">
            <div style="color:#aaa; font-size:12px;">TU CHOFER:</div>
            <div id="infoChofer" style="font-size:18px; font-weight:bold;"></div>
            <div id="infoEco" style="font-size:24px; color:#b39ddb; font-weight:bold; float:right;"></div>
        </div>

        <div id="status-viaje" style="color: #b39ddb; font-weight: bold; margin: 10px;">Listo para pedir</div>
        
        <div id="barra-wrapper"><div id="barra-fill"></div></div>
        
        <button id="btnPedir" class="btn-pedido" onclick="pedirTaxi()">PEDIR TAXI</button>
        <button id="btnCancelar" class="btn-cancelar" onclick="cancelar()" style="display:none;">CANCELAR</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- 1. SEGURIDAD: QUITAR PANTALLA DE CARGA ---
        setTimeout(function() {
            document.getElementById('splash-screen').style.display = 'none';
        }, 2500);

        // --- 2. FIREBASE ---
        var firebaseConfig = { apiKey: "AIzaSyATLT5_woN8KO8-_E4_Nl7bEMlJGFI4uUQ", authDomain: "taxiotimac.firebaseapp.com", databaseURL: "https://taxiotimac-default-rtdb.firebaseio.com", projectId: "taxiotimac", storageBucket: "taxiotimac.firebasestorage.app", messagingSenderId: "533983007458", appId: "1:533983007458:web:254cef6b46c01a1718c4bb" };
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();

        // --- 3. LÃ“GICA ---
        var map = L.map('map').setView([23.6345, -102.5528], 5);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}').addTo(map);

        var iconoTaxi = L.icon({ iconUrl: 'https://img.icons8.com/fluency/96/taxi-location.png', iconSize: [40, 40] });
        var iconoPasajero = L.icon({ iconUrl: 'https://img.icons8.com/fluency/96/marker.png', iconSize: [40, 40] });
        
        var markerCliente, markerChofer;
        var miUUID = localStorage.getItem("otimac_uuid");
        if(!miUUID) {
            miUUID = "ID-" + Math.floor(Math.random()*999999);
            localStorage.setItem("otimac_uuid", miUUID);
        }

        // VERIFICAR USUARIO
        var nombre = localStorage.getItem("nombreCliente");
        if(nombre) {
            iniciarSesion();
        } else {
            document.getElementById('registro').style.display = 'block';
        }

        function guardarNombre() {
            var n = document.getElementById('inputNombre').value;
            if(n) {
                localStorage.setItem("nombreCliente", n);
                iniciarSesion();
            }
        }

        function iniciarSesion() {
            document.getElementById('registro').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('saludo').innerText = "Hola, " + localStorage.getItem("nombreCliente");
            
            var idActivo = localStorage.getItem("idViajeActivo");
            if(idActivo) monitorearViaje(idActivo);
        }

        function pedirTaxi() {
            var btn = document.getElementById('btnPedir');
            btn.innerText = "BUSCANDO...";
            btn.disabled = true;

            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    var lat = pos.coords.latitude;
                    var lon = pos.coords.longitude;
                    var idViaje = miUUID.replace("ID-", "V-");

                    database.ref('viajes/' + idViaje).set({
                        cliente: { lat: lat, lon: lon },
                        nombre_cliente: localStorage.getItem("nombreCliente"),
                        cliente_uid: miUUID,
                        estado: "esperando",
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).then(function() {
                        localStorage.setItem("idViajeActivo", idViaje);
                        monitorearViaje(idViaje);
                    });

                }, function(err) {
                    alert("Error GPS: Activa tu ubicaciÃ³n");
                    btn.disabled = false;
                    btn.innerText = "PEDIR TAXI";
                }, {enableHighAccuracy: true});
            } else {
                alert("Tu celular no soporta GPS");
            }
        }

        function monitorearViaje(id) {
            document.getElementById('btnPedir').style.display = 'none';
            document.getElementById('btnCancelar').style.display = 'block';

            database.ref('viajes/' + id).on('value', function(snapshot) {
                var v = snapshot.val();
                if(!v) {
                    localStorage.removeItem("idViajeActivo");
                    alert("Viaje finalizado o cancelado");
                    location.reload();
                    return;
                }

                // 5 MINUTOS TEMPORIZADOR
                if(v.estado === 'esperando') {
                    var ahora = Date.now();
                    var creado = v.timestamp || ahora;
                    var resta = 300000 - (ahora - creado); // 5 min
                    
                    document.getElementById('barra-wrapper').style.display = 'block';
                    document.getElementById('barra-fill').style.width = ((resta/300000)*100) + "%";

                    if(resta <= 0) {
                        database.ref('viajes/' + id).remove();
                        alert("Tiempo agotado, intenta de nuevo");
                    }
                } else {
                    document.getElementById('barra-wrapper').style.display = 'none';
                }

                // ESTADOS
                if(v.estado === 'chofer_llego') {
                    document.getElementById('status-viaje').innerText = "ðŸš© CHOFER HA LLEGADO";
                    if('vibrate' in navigator) navigator.vibrate(500);
                } else if(v.estado === 'en_curso') {
                    document.getElementById('status-viaje').innerText = "ðŸš• EN CAMINO";
                    document.getElementById('btnCancelar').style.display = 'none';
                }

                // MAPA
                if(v.cliente) {
                    var posC = [v.cliente.lat, v.cliente.lon];
                    if(markerCliente) markerCliente.setLatLng(posC);
                    else { markerCliente = L.marker(posC, {icon: iconoPasajero}).addTo(map); map.setView(posC, 16); }
                }

                if(v.chofer) {
                    document.getElementById('cardChofer').style.display = 'block';
                    document.getElementById('infoChofer').innerText = v.chofer.nombre;
                    document.getElementById('infoEco').innerText = v.chofer.economico;

                    var posCh = [v.chofer.lat, v.chofer.lon];
                    if(markerChofer) markerChofer.setLatLng(posCh);
                    else markerChofer = L.marker(posCh, {icon: iconoTaxi}).addTo(map);
                }
            });
        }

        function cancelar() {
            var id = localStorage.getItem("idViajeActivo");
            if(confirm("Â¿Cancelar?")) {
                database.ref('viajes/' + id).remove();
            }
        }
    </script>
</body>
</html>
