<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasajero - TaxiOtimac</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f4f4f4; margin: 0; padding: 15px; }
        #map { height: 400px; width: 100%; border-radius: 15px; margin-top: 15px; }
        .status-box { background: white; padding: 20px; border-radius: 12px; margin-bottom: 10px; border: 2px solid #ffc107; }
        #viaje-id { font-size: 32px; font-weight: bold; display: block; margin: 10px 0; }
        .btn-pedir { background: #000; color: #fff; border: none; padding: 18px; font-size: 18px; font-weight: bold; border-radius: 10px; width: 100%; }
        .btn-cancelar-cliente { background: #ff4444; color: white; border: none; padding: 10px; border-radius: 5px; margin-top: 10px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>

    <div class="status-box">
        <div id="status">Pide tu taxi ahora</div>
        <div id="info-viaje" style="display:none;">
            CÃ“DIGO: <span id="viaje-id"></span>
            <div id="estimacion" style="color: #2478ff; font-weight: bold;"></div>
            <button class="btn-cancelar-cliente" onclick="cancelarMiViaje()">CANCELAR VIAJE</button>
        </div>
    </div>

    <button class="btn-pedir" id="btnPedir" onclick="pedirTaxi()">ðŸš– PEDIR TAXI</button>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        var firebaseConfig = { apiKey: "AIzaSyATLT5_woN8KO8-_E4_Nl7bEMlJGFI4uUQ", authDomain: "taxiotimac.firebaseapp.com", databaseURL: "https://taxiotimac-default-rtdb.firebaseio.com", projectId: "taxiotimac", storageBucket: "taxiotimac.firebasestorage.app", messagingSenderId: "533983007458", appId: "1:533983007458:web:254cef6b46c01a1718c4bb" };
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();

        var map = L.map('map').setView([23.6345, -102.5528], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var markerCliente, markerChofer, idDelViaje;

        function pedirTaxi() {
            idDelViaje = Math.floor(Math.random() * 90000) + 10000;
            document.getElementById('info-viaje').style.display = 'block';
            document.getElementById('viaje-id').innerText = idDelViaje;
            document.getElementById('btnPedir').style.display = 'none';

            navigator.geolocation.getCurrentPosition((pos) => {
                var lat = pos.coords.latitude, lon = pos.coords.longitude;
                map.setView([lat, lon], 16);
                markerCliente = L.marker([lat, lon]).addTo(map);
                database.ref('viajes/' + idDelViaje).set({ cliente: { lat: lat, lon: lon }, estado: "esperando" });
                escucharEstado();
            });
        }

        function escucharEstado() {
            database.ref('viajes/' + idDelViaje).on('value', (snapshot) => {
                var viaje = snapshot.val();
                if (!viaje || viaje.estado === "cancelado") {
                    alert("Viaje cancelado o finalizado.");
                    location.reload();
                    return;
                }
                if (viaje.chofer) {
                    var latLngChofer = L.latLng(viaje.chofer.lat, viaje.chofer.lon);
                    var dist = (latLngChofer.distanceTo(markerCliente.getLatLng()) / 1000).toFixed(1);
                    document.getElementById('status').innerText = "Â¡Taxi en camino!";
                    document.getElementById('estimacion').innerText = "Distancia: " + dist + " km";
                    if (markerChofer) markerChofer.setLatLng(latLngChofer);
                    else markerChofer = L.marker(latLngChofer).addTo(map);
                }
            });
        }

        function cancelarMiViaje() {
            if(confirm("Â¿Seguro que quieres cancelar tu taxi?")) {
                database.ref('viajes/' + idDelViaje).update({ estado: "cancelado" }).then(() => { location.reload(); });
            }
        }
    </script>
</body>
</html>
